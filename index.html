<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è–ç¶“ç ”è®€ (V30)</title>

    <link rel="apple-touch-icon" sizes="180x180" href="bible-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="bible-icon.png">
    <link rel="icon" type="image/png" href="bible-icon.png">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <link rel="manifest" href="manifest.json">

    <style>
        /* V30: ç´”ç™½éº»é›€é…è‰²å®šç¾© */
        :root {
            --bg: #ffffff; /* èƒŒæ™¯æ”¹ç‚ºç´”ç™½ */
            --text: #333333;
            --primary: #2c3e50;
            --accent: #8e44ad;
            
            /* å¡ç‰‡èˆ‡æŒ‰éˆ•ï¼šç´”ç™½åº• + å¼·é‚Šæ¡† + å¯¦é«”é™°å½± */
            --tile-bg: #ffffff;
            --tile-border: 1px solid #e0e0e0; /* æ›´æ˜é¡¯çš„ç°è‰²é‚Šæ¡† */
            --tile-shadow: 0 4px 10px rgba(0, 0, 0, 0.08); /* æ›´ç´®å¯¦çš„é™°å½± */
            
            --input-bg: #ffffff;
            --nav-btn-bg: #f8f9fa; /* å°èˆªæŒ‰éˆ•ç¨å¾®ç°ä¸€é»é»ä»¥ç¤ºå€åˆ¥ */
            --nav-btn-color: #7f8c8d;
            
            --scripture-size: 1.25rem;
            --highlight-color: #f1c40f55;
            --gemini-title-border: #f39c12;

            /* çµ±ä¸€å…ƒä»¶é«˜åº¦ */
            --element-height: 52px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg); /* ä½¿ç”¨ç´”ç™½èƒŒæ™¯ */
            margin: 0;
            padding: 20px;
            color: var(--text);
            padding-bottom: 120px;
            -webkit-text-size-adjust: 100%;
        }
        .container { max-width: 900px; margin: 0 auto; } /* ç¨å¾®åŠ å¯¬å®¹å™¨ä»¥ä¾¿ä¸¦æ’ */
        
        h1 { text-align: center; color: var(--primary); font-size: 1.5rem; margin-bottom: 5px; }
        .subtitle { text-align: center; color: #888; font-size: 0.9rem; margin-bottom: 15px; }

        /* è¼‰å…¥ç‹€æ…‹ */
        .loading-container { text-align: center; margin: 10px 0 20px 0; }
        .progress-bar { width: 100%; height: 10px; background: #f0f0f0; border-radius: 5px; overflow: hidden; margin-top: 10px; border: 1px solid #e0e0e0; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }

        /* V30: éº»é›€ç‰Œé¢¨æ ¼å¡ç‰‡ (ç§»é™¤é€æ˜åº¦èˆ‡æ¨¡ç³Š) */
        .tile-card {
            background: var(--tile-bg);
            border: var(--tile-border);
            box-shadow: var(--tile-shadow);
            border-radius: 12px; /* ç¨å¾®æ–¹ä¸€é» */
            padding: 25px;
            margin-bottom: 25px;
        }

        /* å·¥å…·åˆ— */
        .tools-row { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 20px;
            align-items: center;
        }
        
        /* æœå°‹æ¡† (éº»é›€é¢¨) */
        .search-input {
            flex-grow: 1;
            height: var(--element-height);
            padding: 0 15px;
            border: 2px solid #eee; /* åŠ ç²—é‚Šæ¡† */
            border-radius: 10px; font-size: 16px;
            background: var(--input-bg); color: var(--text);
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        .search-input:focus { border-color: var(--accent); outline: none; }

        /* æŒ‰éˆ•é€šç”¨æ¨£å¼ (éº»é›€é¢¨) */
        .tile-btn {
            height: var(--element-height);
            border-radius: 10px; 
            font-weight: bold; font-size: 1.1rem;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.1s;
            box-sizing: border-box;
            border: var(--tile-border);
            background: var(--tile-bg);
            color: var(--text);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .tile-btn:active { transform: translateY(2px); box-shadow: none; }
        
        /* ç‰¹æ®ŠæŒ‰éˆ• */
        .search-btn { background: var(--primary); color: white; border: none; min-width: 52px; }
        .read-btn { flex-grow: 2; background-color: var(--primary); color: white; border: none; font-size: 16px; }
        .nav-arrow-btn { flex-grow: 0; min-width: 60px; background-color: var(--nav-btn-bg); color: var(--nav-btn-color); font-size: 20px; }

        /* V30: åº•éƒ¨æ§åˆ¶å€åŸŸä½ˆå±€ (é—œéµä¿®æ”¹) */
        .bottom-controls-wrapper {
            display: flex;
            gap: 20px;
            align-items: flex-start; /* é ‚éƒ¨å°é½Š */
            margin-top: 10px;
            border-top: 2px solid #f5f5f5; /* åŠ ä¸€æ¢åˆ†éš”ç·š */
            padding-top: 25px;
        }

        /* å·¦å´ï¼šå°èˆªæŒ‰éˆ•çµ„ */
        .nav-buttons-group {
            flex: 0 0 auto; /* ä¸ç¸®æ”¾ï¼Œå›ºå®šå¯¬åº¦ */
            display: flex; gap: 10px;
            min-width: 240px;
        }

        /* å³å´ï¼šé¸å–®æ§åˆ¶çµ„ */
        .selectors-group {
            flex: 1 1 auto; /* ä½”æ“šå‰©é¤˜ç©ºé–“ */
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
            opacity: 0.5; pointer-events: none; transition: opacity 0.3s;
        }
        .selectors-group.active { opacity: 1; pointer-events: all; }
        
        .full-width { grid-column: 1 / -1; }
        .verse-group { display: flex; align-items: center; gap: 8px; grid-column: 1 / -1; }
        
        /* ä¸‹æ‹‰é¸å–® (éº»é›€é¢¨) */
        select {
            height: var(--element-height);
            padding: 0 15px;
            border: 2px solid #eee;
            border-radius: 10px;
            font-size: 16px; width: 100%; 
            background: var(--input-bg); color: var(--text);
            box-sizing: border-box;
            -webkit-appearance: none; /* ç§»é™¤åŸç”Ÿæ¨£å¼ä»¥çµ±å¤–è§€ */
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23999%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-13%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2013l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 15px top 50%;
            background-size: 12px auto;
        }
        select:focus { border-color: var(--accent); outline: none; }

        /* æœå°‹çµæœå€ */
        .search-results {
            max-height: 300px; overflow-y: auto; display: none;
            background: var(--tile-bg); border: var(--tile-border); border-radius: 12px;
            margin-bottom: 20px; padding: 5px 0; color: var(--text);
            box-shadow: var(--tile-shadow);
        }
        .result-item { padding: 15px 20px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; }
        .result-item:hover { background: #f9f9f9; }
        .result-ref { font-weight: bold; color: var(--accent); display: block; margin-bottom: 6px; }
        .result-text { font-size: 0.95rem; opacity: 0.9; line-height: 1.6; }

        /* ç¶“æ–‡å¡ç‰‡ */
        .scripture-card {
            display: none;
            border-left: 6px solid var(--accent);
        }

        /* åŠŸèƒ½æŒ‰éˆ•å€ */
        .action-area { 
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 25px; 
            align-items: stretch;
        }
        
        .action-btn {
            height: auto; min-height: 52px;
            padding: 10px; border: none; color: white; font-size: 0.9rem; line-height: 1.3;
            white-space: normal; text-align: center;
        }

        .ai-btn { background: linear-gradient(135deg, #e67e22 0%, #d35400 100%); }
        .grok-btn { background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%); }
        .copy-btn { background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); }

        .ref-title {
            font-size: 1.4rem; font-weight: bold; color: var(--accent);
            margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px;
        }
        .scripture-text {
            font-size: var(--scripture-size); 
            line-height: 1.9; white-space: pre-wrap; color: var(--text);
            margin-bottom: 25px;
        }
        .verse-num { color: #999; font-weight: normal; font-size: 0.75em; margin-right: 8px; vertical-align: super; }

        /* é–±è®€æ•´ç« æŒ‰éˆ• */
        .context-btn {
            width: 100%; margin-bottom: 25px; border: none;
            color: white; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            display: none;
        }

        /* Gemini å€å¡Š */
        .gemini-section {
            display: none; margin-top: 25px;
            border: 2px solid #f39c12; /* Gemini ç‰¹è‰²é‚Šæ¡† */
        }
        .gemini-header {
            display: flex; align-items: center; gap: 10px;
            font-size: 1.2rem; font-weight: bold; color: var(--text);
            margin-bottom: 15px; border-bottom: 2px solid #f39c12; padding-bottom: 10px;
        }
        .gemini-content { font-size: 1.05rem; line-height: 1.7; color: var(--text); opacity: 0.95; }
        .gemini-content h1, .gemini-content h2, .gemini-content h3 { 
            color: var(--primary); margin-top: 20px; margin-bottom: 10px; font-size: 1.1em; 
        }
        .gemini-content strong { color: #c0392b; background: #fff5e6; padding: 0 4px; }
        
        .ai-loading { text-align: center; padding: 30px; font-style: italic; color: #888; display: none; }
        .ai-spinner {
            display: inline-block; width: 24px; height: 24px;
            border: 3px solid #eee; border-top: 3px solid var(--gemini-title-border);
            border-radius: 50%; animation: spin 1s linear infinite; margin-right: 12px; vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .footer-note {
            text-align: right; font-size: 0.8rem; color: #aaa;
            border-top: 1px solid #eee; padding-top: 15px; font-style: italic; margin-top: 30px;
        }

        /* V30: æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼èª¿æ•´ (é‡è¦) */
        @media (max-width: 768px) { 
            /* åœ¨æ‰‹æ©Ÿä¸Šï¼Œå¼·åˆ¶è®Šå›å‚ç›´å †ç–Šï¼Œå¦å‰‡æ”¾ä¸ä¸‹ */
            .bottom-controls-wrapper {
                flex-direction: column-reverse; /* é¸å–®åœ¨ä¸Šï¼ŒæŒ‰éˆ•åœ¨ä¸‹ */
                gap: 15px;
            }
            .nav-buttons-group, .selectors-group {
                width: 100%; /* å¡«æ»¿å¯¬åº¦ */
            }
            .selectors-group { grid-template-columns: 1fr; } /* é¸å–®ä¹Ÿè®Šå–®æ¬„ */
            .action-area { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="tile-card main-control-card">
        <h1>ğŸ“– è–ç¶“ç ”è®€</h1>
        <div class="subtitle">è³‡æ–™ä¾†æºï¼šå’Œåˆæœ¬ç¹é«” (Github/cokcok1)</div>

        <div id="loadingArea" class="loading-container">
            <div id="loadingText">æ­£åœ¨ä¸‹è¼‰è³‡æ–™åº« (4.5MB)...</div>
            <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
        </div>

        <div class="tools-row" id="toolsRow" style="display:none;">
            <input type="text" id="searchInput" class="search-input" placeholder="è¼¸å…¥é—œéµå­— (å¦‚: æ„›äººå¦‚å·±)">
            <button class="tile-btn search-btn" onclick="searchBible()">ğŸ”</button>
        </div>

        <div id="searchResults" class="search-results"></div>

        <div class="bottom-controls-wrapper">
            
            <div class="nav-buttons-group">
                <button class="tile-btn nav-arrow-btn" onclick="prevChapter()" title="ä¸Šä¸€ç« ">â®</button>
                <button class="tile-btn read-btn" onclick="displayScripture()">é–±è®€ç¶“æ–‡</button>
                <button class="tile-btn nav-arrow-btn" onclick="nextChapter()" title="ä¸‹ä¸€ç« ">â¯</button>
            </div>

            <div id="controlGrid" class="selectors-group">
                <select id="bookSelect" class="full-width" onchange="updateChapters()"><option>è¼‰å…¥ä¸­...</option></select>
                
                <div style="display: contents;"> <select id="chapterSelect" onchange="updateStartVerses()"><option>-</option></select>
                    
                    <div class="verse-group">
                        <select id="startVerseSelect" style="flex-grow:1;" onchange="updateEndVerses()"><option>-</option></select>
                        <span id="toLabel" style="display:none;">è‡³</span>
                        <select id="endVerseSelect" style="flex-grow:1; display:none;"><option>-</option></select>
                    </div>
                </div>
            </div>

        </div> </div>

    <div id="resultCard" class="tile-card scripture-card">
        
        <div id="actionArea" class="action-area">
            <button class="tile-btn action-btn ai-btn" onclick="callGeminiAPI()">âœ¨ Geminiè§£ç¶“<br>(VPN/éé¦™æ¸¯ç”¨æˆ¶)</button>
            <button class="tile-btn action-btn grok-btn" onclick="openGrok()">ğŸš€ è¤‡è£½ä¸¦å‰å¾€Grok</button>
            <button class="tile-btn action-btn copy-btn" id="copyBtn" onclick="copyPrompt()">ğŸ“‹ åƒ…è¤‡è£½æŒ‡ä»¤</button>
        </div>

        <div class="ref-title" id="displayRef"></div>
        <div class="scripture-text" id="displayText"></div>

        <button id="contextBtn" class="tile-btn context-btn" onclick="switchToWholeChapter()">ğŸ“– é–±è®€æ•´ç«  (é¡¯ç¤ºä¸Šä¸‹æ–‡)</button>

        <div id="geminiSection" class="tile-card gemini-section">
            <div class="gemini-header">
                <span>ğŸ¤– Gemini 2.0 Flash è§£è®€</span>
            </div>
            <div id="aiLoading" class="ai-loading">
                <div class="ai-spinner"></div> æ­£åœ¨é€£ç·š Google Gemini æ€è€ƒç¥å­¸æ„æ¶µ...
            </div>
            <div id="geminiResult" class="gemini-content"></div>
        </div>

        <div class="footer-note" id="footerVer">Powered by Google Gemini AIè§£é‡‹å…§å®¹åªä¾›åƒè€ƒ 2025-12-30 (V30)</div>
    </div>
</div>

<textarea id="hiddenPrompt" style="display:none;"></textarea>

<script>
    const GEMINI_API_URL = 'https://little-thunder-4b7b.imsklam1.workers.dev';
    const BIBLE_URL = 'https://cokcok1.github.io/bible-ai/chinese_union_trad_trad.txt';
    
    let bibleData = {};
    let bookOrder = [];

    const today = new Date().toISOString().split('T')[0];
    document.getElementById('footerVer').innerText = `Powered by Google Gemini AIè§£é‡‹å…§å®¹åªä¾›åƒè€ƒ ${today} (V30)`;

    window.onload = async function() {
        try {
            const response = await fetch(BIBLE_URL);
            if (!response.ok) throw new Error("ç¶²çµ¡ä¸‹è¼‰å¤±æ•—");
            const reader = response.body.getReader();
            const contentLength = +response.headers.get('Content-Length');
            let receivedLength = 0;
            let chunks = [];
            while(true) {
                const {done, value} = await reader.read();
                if (done) break;
                chunks.push(value);
                receivedLength += value.length;
                if (contentLength) document.getElementById('progressFill').style.width = (receivedLength / contentLength * 100) + "%";
            }
            document.getElementById('loadingText').innerText = "è§£æçµæ§‹ä¸­...";
            let text = new TextDecoder("utf-8").decode(concatUint8Arrays(chunks));
            parseBibleText(text);
            document.getElementById('loadingArea').style.display = 'none';
            // V30: é€™è£¡è¦æŒ‡å‘æ–°çš„ selectors-group
            document.getElementById('controlGrid').className += ' active';
            document.getElementById('toolsRow').style.display = 'flex';
            initSelectors();
        } catch (e) {
            document.getElementById('loadingText').innerText = "éŒ¯èª¤ï¼š" + e.message;
        }
    };

    function concatUint8Arrays(arrays) {
        let totalLength = arrays.reduce((acc, val) => acc + val.length, 0);
        let result = new Uint8Array(totalLength);
        let len = 0;
        for (let arr of arrays) { result.set(arr, len); len += arr.length; }
        return result;
    }

    function parseBibleText(rawText) {
        const lines = rawText.split('\n');
        const lineRegex = /^(.+?)\s+(\d+):(\d+)\s+(.*)$/;
        lines.forEach(line => {
            line = line.trim();
            if (!line) return;
            const match = line.match(lineRegex);
            if (match) {
                const book = match[1];
                const chapter = parseInt(match[2]);
                const verse = parseInt(match[3]);
                const content = match[4];
                if (!bibleData[book]) { bibleData[book] = {}; bookOrder.push(book); }
                if (!bibleData[book][chapter]) { bibleData[book][chapter] = {}; }
                bibleData[book][chapter][verse] = content;
            }
        });
    }

    function searchBible() {
        const rawKeyword = document.getElementById('searchInput').value.trim();
        const resultsDiv = document.getElementById('searchResults');
        
        if (!rawKeyword) { alert("è«‹è¼¸å…¥æœå°‹é—œéµå­—"); return; }
        const cleanKeyword = rawKeyword.replace(/\s+/g, '');
        if (cleanKeyword.length < 1) return;

        resultsDiv.style.display = 'block';
        resultsDiv.innerHTML = '<div style="padding:15px; color:#888; text-align:center;">ğŸ” æ­£åœ¨æœå°‹å…¨æœ¬è–ç¶“...</div>';

        setTimeout(() => {
            let results = [];
            let count = 0;
            const maxResults = 100;

            for (let book of bookOrder) {
                for (let chap in bibleData[book]) {
                    for (let ver in bibleData[book][chap]) {
                        const originalText = bibleData[book][chap][ver];
                        const cleanText = originalText.replace(/\s+/g, '');
                        
                        if (cleanText.includes(cleanKeyword)) {
                            results.push({ book, chap, ver, text: originalText });
                            count++;
                            if (count >= maxResults) break;
                        }
                    }
                    if (count >= maxResults) break;
                }
                if (count >= maxResults) break;
            }

            if (results.length === 0) {
                resultsDiv.innerHTML = `<div style="padding:15px; color:var(--primary); text-align:center;">æ‰¾ä¸åˆ°é—œæ–¼ã€Œ${rawKeyword}ã€çš„ç¶“æ–‡ã€‚</div>`;
            } else {
                let html = `<div style="padding:10px 20px; border-bottom:2px solid #eee; color:var(--primary); font-weight:bold;">
                    æ‰¾åˆ° ${results.length}${count >= maxResults ? '+' : ''} è™•ç¶“æ–‡ (é»æ“Šè·³è½‰):
                    <button style="float:right; border:none; background:none; color:#999; cursor:pointer; font-size:1.2rem;" onclick="closeSearch()">âœ•</button>
                </div>`;
                
                const escapedKeyword = cleanKeyword.split('').map(c => c.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('\\s*');
                const highlightRegex = new RegExp(`(${escapedKeyword})`, 'g');

                results.forEach(res => {
                    const highlighted = res.text.replace(highlightRegex, `<span style="background:var(--highlight-color); font-weight:bold; padding:2px 4px; border-radius:4px;">$1</span>`);
                    html += `<div class="result-item" onclick="jumpToScripture('${res.book}', ${res.chap}, ${res.ver})">
                        <span class="result-ref">${res.book} ${res.chap}:${res.ver}</span>
                        <div class="result-text">${highlighted}</div>
                    </div>`;
                });
                resultsDiv.innerHTML = html;
            }
        }, 50);
    }

    function closeSearch() {
        document.getElementById('searchResults').style.display = 'none';
    }

    function jumpToScripture(book, chap, ver) {
        bookSel.value = book;
        updateChapters();
        chapSel.value = chap;
        updateStartVerses();
        startVerSel.value = ver;
        updateEndVerses();
        
        document.getElementById('searchInput').value = '';
        
        displayScripture();
        closeSearch();
        document.getElementById('resultCard').scrollIntoView({ behavior: 'smooth' });
    }

    function switchToWholeChapter() {
        startVerSel.value = 'all';
        updateEndVerses();
        displayScripture();
    }

    // --- åŸæœ‰é‚è¼¯ ---
    const bookSel = document.getElementById('bookSelect');
    const chapSel = document.getElementById('chapterSelect');
    const startVerSel = document.getElementById('startVerseSelect');
    const endVerSel = document.getElementById('endVerseSelect');

    function initSelectors() {
        bookSel.innerHTML = "";
        bookOrder.forEach(bk => {
            let op = document.createElement('option');
            op.value = bk; op.text = bk; bookSel.add(op);
        });
        updateChapters();
    }

    function updateChapters() {
        const book = bookSel.value;
        chapSel.innerHTML = "";
        const chaps = Object.keys(bibleData[book]).map(Number).sort((a,b)=>a-b);
        chaps.forEach(ch => {
            let op = document.createElement('option');
            op.value = ch; op.text = `ç¬¬ ${ch} ç« `; chapSel.add(op);
        });
        updateStartVerses();
    }

    function updateStartVerses() {
        const book = bookSel.value;
        const chap = chapSel.value;
        startVerSel.innerHTML = '<option value="all">æ•´ç«  (Whole Chapter)</option>';
        if (bibleData[book] && bibleData[book][chap]) {
            const verses = Object.keys(bibleData[book][chap]).map(Number).sort((a,b)=>a-b);
            verses.forEach(v => {
                let op = document.createElement('option');
                op.value = v; op.text = `ç¬¬ ${v} ç¯€`; startVerSel.add(op);
            });
        }
        updateEndVerses();
    }

    function updateEndVerses() {
        const startVal = startVerSel.value;
        if (startVal === "all") {
            document.getElementById('toLabel').style.display = "none";
            endVerSel.style.display = "none";
            return;
        }
        document.getElementById('toLabel').style.display = "block";
        endVerSel.style.display = "block";
        endVerSel.innerHTML = "";
        const book = bookSel.value;
        const chap = chapSel.value;
        const startNum = parseInt(startVal);
        if (bibleData[book] && bibleData[book][chap]) {
            const verses = Object.keys(bibleData[book][chap]).map(Number).sort((a,b)=>a-b);
            verses.forEach(v => {
                if (v >= startNum) {
                    let op = document.createElement('option');
                    op.value = v; op.text = `ç¬¬ ${v} ç¯€`; endVerSel.add(op);
                }
            });
        }
    }

    function nextChapter() {
        const currentBook = bookSel.value;
        const currentChap = parseInt(chapSel.value);
        if (bibleData[currentBook][currentChap + 1]) {
            chapSel.value = currentChap + 1;
        } else {
            const bookIdx = bookOrder.indexOf(currentBook);
            if (bookIdx < bookOrder.length - 1) {
                const nextBook = bookOrder[bookIdx + 1];
                bookSel.value = nextBook;
                updateChapters();
                chapSel.value = 1;
            } else {
                alert("å·²ç¶“æ˜¯æœ€å¾Œä¸€ç« äº†");
                return;
            }
        }
        updateStartVerses(); displayScripture();
    }

    function prevChapter() {
        const currentBook = bookSel.value;
        const currentChap = parseInt(chapSel.value);
        if (currentChap > 1) {
            chapSel.value = currentChap - 1;
        } else {
            const bookIdx = bookOrder.indexOf(currentBook);
            if (bookIdx > 0) {
                const prevBook = bookOrder[bookIdx - 1];
                bookSel.value = prevBook;
                updateChapters();
                const chaps = Object.keys(bibleData[prevBook]).map(Number);
                chapSel.value = Math.max(...chaps);
            } else {
                alert("å·²ç¶“æ˜¯ç¬¬ä¸€ç« äº†");
                return;
            }
        }
        updateStartVerses(); displayScripture();
    }

    function displayScripture() {
        document.getElementById('geminiSection').style.display = 'none';
        document.getElementById('geminiResult').innerHTML = '';
        
        const book = bookSel.value;
        const chap = chapSel.value;
        const startVer = startVerSel.value;
        let displayText = "";
        let refText = "";
        const contextBtn = document.getElementById('contextBtn');
        
        if (startVer === "all") {
            refText = `${book} ç¬¬ ${chap} ç« `;
            const verses = bibleData[book][chap];
            Object.keys(verses).map(Number).sort((a,b)=>a-b).forEach(v => {
                displayText += `<span class='verse-num'>[${v}]</span>${verses[v]}\n`;
            });
            contextBtn.style.display = "none";
        } else {
            const startNum = parseInt(startVer);
            const endNum = parseInt(endVerSel.value);
            if (startNum === endNum) {
                 refText = `${book} ç¬¬ ${chap} ç«  ç¬¬ ${startNum} ç¯€`;
            } else {
                 refText = `${book} ç¬¬ ${chap} ç«  ${startNum}-${endNum} ç¯€`;
            }
            for (let i = startNum; i <= endNum; i++) {
                if (bibleData[book][chap][i]) {
                    displayText += `<span class='verse-num'>[${i}]</span>${bibleData[book][chap][i]}\n`;
                }
            }
            contextBtn.style.display = "block";
        }

        document.getElementById('resultCard').style.display = 'block';
        document.getElementById('displayRef').innerText = refText;
        document.getElementById('displayText').innerHTML = displayText;
        document.getElementById('actionArea').style.display = 'grid';

        generateHiddenPrompt(refText, "");
    }

    function generateHiddenPrompt(ref, text) {
        const prompt = `è«‹ç”¨ä¸­æ–‡ï¼ˆç¹é«”ï¼‰ä¸¦ä»¥åŸºç£æ•™ä¿¡ä»°å’Œè–ç¶“çœŸç†ç‚ºåŸºç¤ï¼Œè§£é‡‹è–ç¶“ã€${ref}ã€‘ã€‚

è«‹æä¾›ï¼š
- ã€ç¶“æ–‡æ¦‚è¦ã€‘æ¦‚è¿°æ­¤ç« å…§å®¹èˆ‡ä¸»è¦äº‹ä»¶ã€‚
- ã€ç¶“æ–‡è§£é‡‹ã€‘è©³ç´°é—¡è¿°è©²ç¯€çš„å«ç¾©ã€‚
- ã€ç¥å­¸é‡é»ã€‘æŒ‡å‡ºæ ¸å¿ƒç¥å­¸ä¿¡æ¯ã€æ•‘æ©å•Ÿç¤ºåŠå±¬éˆä¿¡æ¯ã€‚
- ã€æ­·å²æ–‡åŒ–èƒŒæ™¯ã€‘è£œå……èˆ‡ç†è§£æœ¬ç« ç›¸é—œçš„èƒŒæ™¯è³‡æ–™ã€‚
- ã€å¼•ç”¨ã€‘åˆ—å‡ºå…¶ä»–è–ç¶“ç›¸é—œç¶“æ–‡ï¼Œä¸¦èªªæ˜å…¶é—œè¯ã€‚
- ã€å±¬éˆæ‡‰ç”¨ã€‘æä¾›å¦‚ä½•å°‡æ­¤ç« çš„ä¿¡æ¯æ‡‰ç”¨æ–¼ä¿¡å¾’ç”Ÿæ´»ã€‚
- ã€é»˜æƒ³èˆ‡åæ€å•é¡Œã€‘æå‡º2-3å€‹å¼•å°æ€è€ƒèˆ‡éˆä¿®çš„å•é¡Œã€‚`;
        document.getElementById('hiddenPrompt').value = prompt;
    }

    async function callGeminiAPI() {
        const prompt = document.getElementById('hiddenPrompt').value;
        if(!prompt) { alert("è«‹å…ˆé–±è®€ç¶“æ–‡"); return; }
        const section = document.getElementById('geminiSection');
        const loading = document.getElementById('aiLoading');
        const result = document.getElementById('geminiResult');
        
        section.style.display = 'block';
        loading.style.display = 'block';
        result.innerHTML = '';
        section.scrollIntoView({ behavior: 'smooth' });

        try {
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const response = await fetch(GEMINI_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error(`Cloudflare é€£ç·šéŒ¯èª¤: ${response.status}`);
            const data = await response.json();
            if (data.error) throw new Error(data.error.message || "Google API æœªçŸ¥éŒ¯èª¤");
            if (!data.candidates || !data.candidates[0]) throw new Error("API å›å‚³çµæ§‹ç•°å¸¸");

            const rawMarkdown = data.candidates[0].content.parts[0].text;
            result.innerHTML = parseMarkdown(rawMarkdown);
        } catch (error) {
            result.innerHTML = `<span style="color:red; font-weight:bold;">éŒ¯èª¤ï¼š${error.message}</span>`;
            console.error(error);
        } finally {
            loading.style.display = 'none';
        }
    }

    function parseMarkdown(text) {
        let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
        html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
        html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
        html = html.replace(/^\* (.*$)/gim, '<li>$1</li>');
        html = html.replace(/^\- (.*$)/gim, '<li>$1</li>');
        html = html.replace(/\n{3,}/g, '\n\n');
        html = html.replace(/(<\/h[1-3]>)\n+/g, '$1');
        html = html.replace(/\n/g, '<br>');
        return html;
    }

    function openGrok() {
        const txt = document.getElementById('hiddenPrompt').value;
        if (!txt) { alert("è«‹å…ˆé¸æ“‡ç¶“æ–‡"); return; }
        fallbackCopy(txt, () => {
            alert("âœ… æŒ‡ä»¤å·²è¤‡è£½ï¼\nå³å°‡æ‰“é–‹ Grokï¼Œè«‹åœ¨å°è©±æ¡†æŒ‰ã€Œè²¼ä¸Šã€(Ctrl+V) å³å¯ã€‚");
            window.open('https://grok.com', '_blank');
        });
    }

    function copyPrompt() {
        const txt = document.getElementById('hiddenPrompt').value;
        if (!txt) return;
        const onSuccess = () => {
            const btn = document.getElementById('copyBtn');
            const originalText = "ğŸ“‹ åƒ…è¤‡è£½æŒ‡ä»¤";
            btn.innerText = "âœ… æˆåŠŸ";
            btn.style.backgroundColor = "#27ae60";
            setTimeout(() => { btn.innerText = originalText; btn.style.backgroundColor = ""; }, 2000);
        };
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(txt).then(onSuccess).catch(() => fallbackCopy(txt, onSuccess));
        } else {
            fallbackCopy(txt, onSuccess);
        }
    }

    function fallbackCopy(text, callback) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "absolute";
        textArea.style.left = "-9999px";
        textArea.setAttribute("readonly", "");
        document.body.appendChild(textArea);
        if (navigator.userAgent.match(/ipad|ipod|iphone/i)) {
            const range = document.createRange();
            range.selectNodeContents(textArea);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            textArea.setSelectionRange(0, 999999);
        } else {
            textArea.select();
        }
        try { if (document.execCommand('copy')) callback(); else alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é•·æŒ‰é¸æ“‡"); } 
        catch (err) { alert("ç€è¦½å™¨ä¸æ”¯æ´è¤‡è£½"); }
        document.body.removeChild(textArea);
    }
</script>

</body>
</html>
